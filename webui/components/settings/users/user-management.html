<div x-data>
  <script type="module" src="/components/settings/users/user-management-store.js"></script>
  <div class="section">
    <div class="section-title">Gestion des Utilisateurs</div>
    <div class="section-description">Créer, modifier et supprimer des utilisateurs. Seuls les administrateurs ont accès à cette section.</div>

    <div class="field field-full" x-data="$store.userManagementStore" x-init="init()">
      <!-- Header actions -->
      <div class="field-control" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
        <button class="btn btn-ok" @click="openCreateForm()">
          <span class="material-symbols-outlined">person_add</span>
          Créer un nouvel utilisateur
        </button>
        <span x-show="loading">Chargement...</span>
        <span class="status-error" x-show="error" x-text="error"></span>
      </div>

      <!-- Users list -->
      <div class="table-container" style="margin-top: .75rem; overflow:auto;" x-show="!formMode">
        <table class="table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Rôle</th>
              <th>Créé le</th>
              <th>Créé par</th>
              <th>Dernière connexion</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="u in users" :key="u.id">
              <tr>
                <td x-text="u.username"></td>
                <td>
                  <span :class="{'badge': true, 'badge-blue': u.role==='admin', 'badge-gray': u.role==='user'}" x-text="u.role"></span>
                </td>
                <td x-text="u.created_at || ''"></td>
                <td x-text="u.created_by || ''"></td>
                <td x-text="u.last_login || ''"></td>
                <td>
                  <button class="btn btn-field" title="Modifier" @click="openEditForm(u)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="btn btn-cancel" title="Supprimer" @click="openDeleteConfirm(u)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Form section (create/edit) -->
      <div class="section" x-show="formMode==='create' || formMode==='edit'">
        <div class="section-title" x-text="formMode==='create' ? 'Créer un utilisateur' : 'Modifier l\'utilisateur'"></div>
        <div class="section-description" x-show="statusMessage">
          <span :class="{'status-success': statusType==='success', 'status-error': statusType==='error', 'status-info': statusType==='info'}" x-text="statusMessage"></span>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Username</div>
          </div>
          <div class="field-control">
            <input type="text" x-model="formData.username" :readonly="formMode==='edit'">
            <div class="validation-error" x-show="validationErrors.username" x-text="validationErrors.username"></div>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title" x-text="formMode==='edit' ? 'Nouveau mot de passe' : 'Mot de passe'"></div>
            <div class="field-description" x-text="formMode==='edit' ? 'Laisser vide pour ne pas changer' : 'Min. 6 caractères'"></div>
          </div>
          <div class="field-control">
            <input type="password" x-model="formData.password" :placeholder="formMode==='edit' ? 'Laisser vide pour ne pas changer' : ''">
            <div class="validation-error" x-show="validationErrors.password" x-text="validationErrors.password"></div>
          </div>
        </div>

        <div class="field">
          <div class="field-label"><div class="field-title">Rôle</div></div>
          <div class="field-control">
            <select x-model="formData.role">
              <option value="admin">Admin</option>
              <option value="user">User</option>
            </select>
            <div class="validation-error" x-show="validationErrors.role" x-text="validationErrors.role"></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-cancel" @click="closeForm()">
            <span class="material-symbols-outlined">cancel</span>
            Annuler
          </button>
          <button class="btn btn-field" x-show="formData.id" :disabled="isTesting || !formData.password" @click="testCredentials()">
            <span class="material-symbols-outlined">play_circle</span>
            <span x-text="isTesting ? 'Test en cours...' : 'Tester les identifiants'"></span>
          </button>
          <button class="btn btn-ok" @click="formMode==='create' ? createUser() : updateUser()">
            <span class="material-symbols-outlined">save</span>
            Enregistrer
          </button>
        </div>
      </div>

      <!-- Delete confirmation section -->
      <div class="section" x-show="formMode==='delete'">
        <div class="section-title">Supprimer l'utilisateur</div>
        <div class="section-description">
          <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong x-text="currentUser?.username"></strong> ?</p>
          <p class="status-error">Attention: il doit rester au moins un administrateur actif.</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-cancel" @click="closeForm()">Annuler</button>
          <button class="btn btn-cancel" style="background:#b00020;color:#fff;" @click="deleteUser()">Supprimer</button>
        </div>
      </div>

    </div>
  </div>
</div>
