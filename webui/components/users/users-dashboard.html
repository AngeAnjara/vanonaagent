<html>
<head>
  <title>Users Dashboard</title>
  <script type="module">
    import { store } from "/components/users/users-dashboard-store.js";
  </script>
</head>
<body>
  <div x-data>
    <template x-if="$store.usersDashboardStore">
      <div x-create="$store.usersDashboardStore.onOpen()" x-destroy="$store.usersDashboardStore.cleanup()" class="users-dashboard">
    <div class="section-title">Gestion des Utilisateurs</div>
    <div class="section-description">Créer, modifier et supprimer des utilisateurs. Voir l'historique des chats par utilisateur.</div>

    <div class="header-actions">
      <button class="btn btn-ok" @click="$store.usersDashboardStore.openCreateForm()">
        <span class="material-symbols-outlined">person_add</span>
        Créer un utilisateur
      </button>
      <span x-show="$store.usersDashboardStore.loading">Chargement...</span>
      <span class="status-error" x-show="$store.usersDashboardStore.error" x-text="$store.usersDashboardStore.error"></span>
    </div>

    <!-- Users list -->
    <div class="table-container" x-show="!$store.usersDashboardStore.formMode && !$store.usersDashboardStore.selectedUser">
      <table class="table users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Rôle</th>
            <th>Créé le</th>
            <th>Créé par</th>
            <th>Dernière connexion</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="u in $store.usersDashboardStore.paginatedUsers" :key="u.id">
            <tr>
              <td x-text="u.username"></td>
              <td>
                <span :class="{'badge': true, 'badge-blue': u.role==='admin', 'badge-gray': u.role==='user'}" x-text="u.role"></span>
              </td>
              <td x-text="$store.usersDashboardStore.formatDate(u.created_at)"></td>
              <td x-text="u.created_by || ''"></td>
              <td x-text="$store.usersDashboardStore.formatDate(u.last_login)"></td>
              <td>
                <div class="users-actions">
                  <button class="btn btn-field" title="Modifier" @click="$store.usersDashboardStore.openEditForm(u)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="btn btn-cancel" title="Supprimer" @click="$store.usersDashboardStore.openDeleteConfirm(u)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                  <button class="btn btn-field" title="Voir chats" @click="$store.usersDashboardStore.viewUserChats(u)">
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
        <button class="btn btn-cancel" @click="$store.usersDashboardStore.currentPage = Math.max(1, $store.usersDashboardStore.currentPage-1)" :disabled="$store.usersDashboardStore.currentPage<=1">Précédent</button>
        <span x-text="$store.usersDashboardStore.currentPage + ' / ' + $store.usersDashboardStore.totalPages"></span>
        <button class="btn btn-field" @click="$store.usersDashboardStore.currentPage = Math.min($store.usersDashboardStore.totalPages, $store.usersDashboardStore.currentPage+1)" :disabled="$store.usersDashboardStore.currentPage>=$store.usersDashboardStore.totalPages">Suivant</button>
      </div>
    </div>

    <!-- Form section (create/edit) -->
    <div class="section" x-show="$store.usersDashboardStore.formMode==='create' || $store.usersDashboardStore.formMode==='edit'">
      <div class="section-title" x-text="$store.usersDashboardStore.formMode==='create' ? 'Créer un utilisateur' : 'Modifier l\'utilisateur'"></div>
      <div class="section-description status-row" x-show="$store.usersDashboardStore.statusMessage">
        <span :class="{'status-success': $store.usersDashboardStore.statusType==='success', 'status-error': $store.usersDashboardStore.statusType==='error', 'status-info': $store.usersDashboardStore.statusType==='info'}" x-text="$store.usersDashboardStore.statusMessage"></span>
      </div>

      <div class="field">
        <div class="field-label"><div class="field-title">Username</div></div>
        <div class="field-control">
          <input type="text" x-model="$store.usersDashboardStore.formData.username" :readonly="$store.usersDashboardStore.formMode==='edit'">
          <div class="validation-error" x-show="$store.usersDashboardStore.validationErrors.username" x-text="$store.usersDashboardStore.validationErrors.username"></div>
        </div>
      </div>

      <div class="field">
        <div class="field-label">
          <div class="field-title" x-text="$store.usersDashboardStore.formMode==='edit' ? 'Nouveau mot de passe' : 'Mot de passe'"></div>
          <div class="field-description" x-text="$store.usersDashboardStore.formMode==='edit' ? 'Laisser vide pour ne pas changer' : 'Min. 6 caractères'"></div>
        </div>
        <div class="field-control">
          <input type="password" x-model="$store.usersDashboardStore.formData.password" :placeholder="$store.usersDashboardStore.formMode==='edit' ? 'Laisser vide pour ne pas changer' : ''">
          <div class="validation-error" x-show="$store.usersDashboardStore.validationErrors.password" x-text="$store.usersDashboardStore.validationErrors.password"></div>
        </div>
      </div>

      <div class="field">
        <div class="field-label"><div class="field-title">Rôle</div></div>
        <div class="field-control">
          <select x-model="$store.usersDashboardStore.formData.role">
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
          <div class="validation-error" x-show="$store.usersDashboardStore.validationErrors.role" x-text="$store.usersDashboardStore.validationErrors.role"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" @click="$store.usersDashboardStore.closeForm()">
          <span class="material-symbols-outlined">cancel</span>
          Annuler
        </button>
        <button class="btn btn-field" x-show="$store.usersDashboardStore.formData.id" :disabled="$store.usersDashboardStore.isTesting || !$store.usersDashboardStore.formData.password" @click="$store.usersDashboardStore.testCredentials()">
          <span class="material-symbols-outlined">play_circle</span>
          <span x-text="$store.usersDashboardStore.isTesting ? 'Test en cours...' : 'Tester les identifiants'"></span>
        </button>
        <button class="btn btn-ok" @click="$store.usersDashboardStore.formMode==='create' ? $store.usersDashboardStore.createUser() : $store.usersDashboardStore.updateUser()">
          <span class="material-symbols-outlined">save</span>
          Enregistrer
        </button>
      </div>
    </div>

    <!-- Delete confirmation section -->
    <div class="section" x-show="$store.usersDashboardStore.formMode==='delete'">
      <div class="section-title">Supprimer l'utilisateur</div>
      <div class="section-description">
        <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong x-text="$store.usersDashboardStore.currentUser?.username"></strong> ?</p>
        <p class="status-error">Attention: il doit rester au moins un administrateur actif.</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" @click="$store.usersDashboardStore.closeForm()">Annuler</button>
        <button class="btn btn-cancel" style="background:#b00020;color:#fff;" @click="$store.usersDashboardStore.deleteUser()">Supprimer</button>
      </div>
    </div>

    <!-- User Chats section -->
    <div class="section" x-show="$store.usersDashboardStore.selectedUser">
      <div class="section-title">Chats de <span x-text="$store.usersDashboardStore.selectedUser?.username"></span></div>
      <div class="section-description status-row" x-show="$store.usersDashboardStore.statusMessage">
        <span :class="{'status-success': $store.usersDashboardStore.statusType==='success', 'status-error': $store.usersDashboardStore.statusType==='error', 'status-info': $store.usersDashboardStore.statusType==='info'}" x-text="$store.usersDashboardStore.statusMessage"></span>
      </div>
      <div class="header-actions" style="justify-content: space-between;">
        <button class="btn btn-cancel" @click="$store.usersDashboardStore.backToUsersList()">
          <span class="material-symbols-outlined">arrow_back</span>
          Retour
        </button>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <select x-model="$store.usersDashboardStore.chatFilters.type">
            <option value="">Tous les types</option>
            <option value="user">User</option>
            <option value="task">Task</option>
          </select>
          <input type="datetime-local" x-model="$store.usersDashboardStore.chatFilters.dateFrom" />
          <input type="datetime-local" x-model="$store.usersDashboardStore.chatFilters.dateTo" />
        </div>
      </div>

      <div class="table-container" style="margin-top:.5rem;">
        <table class="table users-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Type</th>
              <th>Créé le</th>
              <th>Dernier message</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="c in $store.usersDashboardStore.filteredChats" :key="c.id">
              <tr>
                <td x-text="c.name || ('Chat #' + c.id)"></td>
                <td>
                  <span class="badge" :class="{'badge-blue': c.type==='task', 'badge-gray': c.type!=='task'}" x-text="c.type"></span>
                </td>
                <td x-text="$store.usersDashboardStore.formatDate(c.created_at)"></td>
                <td x-text="$store.usersDashboardStore.formatDate(c.last_message)"></td>
                <td class="users-actions">
                  <button class="btn btn-field" title="Ouvrir" @click="$store.usersDashboardStore.openChat(c)">
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                  <button class="btn btn-cancel" title="Supprimer" @click="$store.usersDashboardStore.deleteUserChat(c.id)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
        <div x-show="!$store.usersDashboardStore.loadingChats && $store.usersDashboardStore.filteredChats.length === 0" style="opacity:.8; font-style:italic;">Aucun chat trouvé</div>
      </div>
    </div>
      </div>
    </template>
  </div>
  <style>
    .users-dashboard { display: flex; flex-direction: column; gap: 1rem; }
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th, .users-table td { border-bottom: 1px solid var(--color-border); padding: 0.5rem; text-align: left; }
    .users-actions { display: flex; gap: .5rem; align-items: center; }
    .header-actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .status-row { min-height: 1.2rem; }
    .status-success { color: #28a745; }
    .status-error { color: #e53935; }
    .status-info { color: #2196f3; }
    @media (max-width: 870px) { .users-table th:nth-child(6), .users-table td:nth-child(6) { white-space: nowrap; } }
  </style>
</body>
</html>
